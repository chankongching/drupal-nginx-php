user www www;  #modify
worker_processes auto;  #modify

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
error_log /var/log/nginx_error.log crit;  #add

#pid        logs/nginx.pid;
pid /var/run/nginx.pid;  #modify
worker_rlimit_nofile 51200;


events {
    use epoll;
    worker_connections 51200;
    multi_accept on;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/access.log  main;

    client_max_body_size 100m;  #add
    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  120; #65;

    #gzip  on;

    # Adding Drupal Specific configurations
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    # Define Nginx MicroCache
    fastcgi_cache_path /dev/shm/microcache levels=1:2 keys_zone=MYAPP:5M max_size=256M inactive=2h;
    fastcgi_cache_key "$scheme$request_method$host$request_uri";

    # Add Cache status into response header
    add_header X-Cache $upstream_cache_status;
    limit_conn_zone $binary_remote_addr zone=gulag:5m;
    map $http_cookie $cache_uid {
        default nil; # hommage to Lisp :)
        ~SESS[[:alnum:]]+=(?<session_id>[[:alnum:]]+) $session_id;
    }

    map $request_method $no_cache {
        default 1;
        HEAD 0;
        GET 0;
    }

    map $http_user_agent $is_bot {
        default  '';
        ~*crawl|goog|yahoo|yandex|spider|bot|tracker|click|parser is_bot;
    }


    server {
        listen       80;
        #server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        root   /var/www/html;
        index  index.php index.html index.htm;

        #  Cache everything by default
        set $no_cache 0;
        #  Don't cache POST requests
        if ($request_method = POST){
            set $no_cache 1;
        }
        #  Don't cache if the URL contains a query string
        if ($query_string != ""){
            set $no_cache 1;
        }
        #  Don't cache the following URLs
        if ($request_uri ~* "/(administrator/|admin/|login.php)"){
            set $no_cache 1;
        }
        #  Don't cache if there is a cookie called PHPSESSID
        if ($http_cookie = "PHPSESSID"){
            set $no_cache 1;
        }
        #  Block download agents ##
        if ($http_user_agent ~* LWP::Simple|BBBike|wget) {
            return 403;
        }
        #Block wordpress scan attack
        location ~ ^/(wp-admin|wp-login\.php) {
            deny all;
        }

        location = /favicon.ico {
            etag       off;
            log_not_found off;
            access_log off;
        }

        # This matters if you use drush
        location = /backup {
            deny all;
        }

        # Very rarely should these ever be accessed outside of your lan
        location ~* \.(txt|log)$ {
            deny all;
        }

        location ~ \..*/.*\.php$ {
            return 403;
        }

        location / {
            etag       off;
            # This is cool because no php is touched for static content
            try_files $uri @rewrite;
            #try_files $uri $uri/ /index.php?$args;
        }


        location @rewrite {
            etag       off;
            # Some modules enforce no slash (/) at the end of the URL
            # Else this rewrite block wouldn't be needed (GlobalRedirect)
            rewrite ^/(.*)$ /index.php?q=$1;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        location ~ \.php$ {
            root           /var/www/html;
            fastcgi_pass   unix:/var/run/php-fpm-www.sock;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  /$document_root$fastcgi_script_name;
            include        fastcgi_params;
            fastcgi_intercept_errors on;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_read_timeout 40;
            fastcgi_cache MYAPP;
            fastcgi_cache_valid 200 301 60s;
            fastcgi_cache_bypass $no_cache;
            fastcgi_no_cache $no_cache;

            # Set cache key to include identifying components
            fastcgi_cache_valid 302     1m;
            fastcgi_cache_valid 404     1s;
            fastcgi_cache_min_uses 1;
            fastcgi_cache_use_stale error timeout invalid_header updating http_500;
            fastcgi_ignore_headers Cache-Control Expires;
            fastcgi_pass_header Set-Cookie;
            fastcgi_pass_header Cookie;

            ## Add a cache miss/hit status header.
            add_header Access-Control-Allow-Origin *;
            add_header X-Micro-Cache $upstream_cache_status;

            ## To avoid any interaction with the cache control headers we expire
            ## everything on this location immediately.
            #expires epoch;
            etag       off;

            ## Cache locking mechanism for protecting the backend of too many
            ## simultaneous requests.
            fastcgi_cache_lock on;
        }

        #  Catch image styles for D7.
        location ^~ /system/temporary/ {
            rewrite ^/system/temporary/(.*)$ /sites/default/files/$1 last;
        }

      #  Catch image styles for D7.
        location ~ ^/sites/.*/files/ {
            log_not_found off;
            expires 1y;
            add_header Pragma public;
            add_header Cache-Control "public, max-age=2592000";
            add_header Access-Control-Allow-Origin *;
            add_header locationheader 1;
            add_header X-Micro-Cache $upstream_cache_status;
            # For Cloudflare
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            try_files $uri @rewrite;
        }

        location ~ ^/sites/.*/files/styles/.*/public/ {
          try_files $uri @rewrite;
        }

        ##
        ## Send all known bots to $args free URLs.
        ##
        location @nobots {
          if ($is_bot) {
            rewrite ^ $scheme://$host$uri? permanent;
          }
          rewrite ^/(.*)$  /index.php?q=$1 last;
        }

        ##
        ## Advagg_css and Advagg_js support.
        ##
        location ~* files/advagg_(?:css|js)/ {
          expires    max;
          access_log off;
        #  access_log /var/log/nginx/access.log;
          etag       off;
          limit_conn gulag 32;
          rewrite    ^/files/advagg_(.*)/(.*)$ /sites/$server_name/files/advagg_$1/$2 last;
          add_header Cache-Control "no-transform, public";
          add_header Last-Modified "Wed, 20 Jan 1988 04:20:42 GMT";
          add_header X-Header "AdvAgg Generator 1.0";
          set $nocache_details "Skip";
          try_files  $uri @nobots;
        }

        ##
        ## CDN Far Future expiration support.
        ##
        location ^~ /cdn/farfuture/ {
          tcp_nodelay   off;
          access_log    off;
        #  access_log /var/log/nginx/access.log;
          log_not_found off;
          etag          off;
          limit_conn gulag 32;
          gzip_http_version 1.0;
          if_modified_since exact;
          location ~* ^/cdn/farfuture/.+\.(?:css|js|jpe?g|gif|png|ico|bmp|swf|pdf|docx?|xlsx?|pptx?|tiff?|txt|rtf|class|otf|ttf|woff|eot|less)$ {
            expires max;
            add_header X-Header "CDN Far Future Generator 1.0";
            add_header Cache-Control "no-transform, public";
            add_header Last-Modified "Wed, 20 Jan 1988 04:20:42 GMT";
            rewrite ^/cdn/farfuture/[^/]+/[^/]+/(.+)$ /$1 break;
            try_files $uri @nobots;
          }
          location ~* ^/cdn/farfuture/ {
            expires 1y;
            add_header X-Header "CDN Far Future Generator 1.1";
            add_header Cache-Control "private, must-revalidate, proxy-revalidate";
            rewrite ^/cdn/farfuture/[^/]+/[^/]+/(.+)$ /$1 break;
            try_files $uri @nobots;
          }
          try_files $uri @nobots;
        }

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg)$ {
            #    add_header Content-Type "binary/octet-stream";
            log_not_found off;
            expires 1y;
            add_header Pragma public;
            add_header Cache-Control "public, max-age=2592000";
            add_header Access-Control-Allow-Origin *;
            add_header locationheader 1;
            add_header X-Micro-Cache $upstream_cache_status;
            # For Cloudflare
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            try_files $uri @rewrite;
        }

        location ~* \.(eot|ttf|woff) {
            expires 1y;
            add_header Cache-Control "public, max-age=2592000";
            #    add_header X-Micro-Cache $upstream_cache_status always;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            try_files $uri @rewrite;
        }
    }

    #add
    ##########################vhost#####################################
    include vhost/*.conf;

}

daemon off;
